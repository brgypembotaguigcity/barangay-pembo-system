<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resident Dashboard - Barangay Pembo System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .sidebar-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
        }

        .sidebar-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            color: #333;
        }

        .sidebar-header p {
            font-size: 14px;
            color: #666;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }

        .menu-item:hover {
            background: #f0f0f0;
            color: #667eea;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .menu-item svg {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
        }

        .header p {
            color: #666;
            margin-top: 5px;
        }

        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #51cf66, #40c057);
            color: white;
        }

        .stat-card.yellow {
            background: linear-gradient(135deg, #ffd43b, #fab005);
            color: white;
        }

        .stat-info h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-info p {
            font-size: 14px;
            opacity: 0.9;
        }

        .stat-icon {
            font-size: 48px;
            opacity: 0.3;
        }

        /* Application Cards */
        .apply-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .apply-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .apply-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .apply-card-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 30px;
        }

        .apply-card-icon.blue {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .apply-card-icon.green {
            background: linear-gradient(135deg, #51cf66, #40c057);
            color: white;
        }

        .apply-card h3 {
            font-size: 20px;
            color: #333;
            margin-bottom: 10px;
        }

        .apply-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Content Section */
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .content-section h2 {
            font-size: 22px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* Application List */
        .application-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .application-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .app-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .app-info p {
            color: #666;
            font-size: 13px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background: #f0f0f0;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background: #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 15px;
            }

            .main-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="images/Barangay.jpg" alt="Logo">
                <h2 id="userName">Welcome, Resident</h2>
                <p>Barangay Pembo</p>
            </div>

            <div class="menu">
                <div class="menu-item active" onclick="showSection('dashboard')">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    Dashboard
                </div>
                <div class="menu-item" onclick="showSection('applications')">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
                    My Applications
                </div>
                <div class="menu-item" onclick="showSection('appointments')">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>
                    Appointments
                </div>
                <div class="menu-item" onclick="showSection('complaints')">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                    Complaints
                </div>
                <div class="menu-item" onclick="showSection('profile')">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    My Profile
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div>
                    <h1>Resident Dashboard</h1>
                    <p id="currentDate"></p>
                </div>
                <button class="logout-btn" onclick="logout()">Log Out</button>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section-content">
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-info">
                            <h3 id="totalApps">0</h3>
                            <p>Total Applications</p>
                        </div>
                        <div class="stat-icon">üìÑ</div>
                    </div>

                    <div class="stat-card green">
                        <div class="stat-info">
                            <h3 id="approvedApps">0</h3>
                            <p>Approved</p>
                        </div>
                        <div class="stat-icon">‚úì</div>
                    </div>

                    <div class="stat-card yellow">
                        <div class="stat-info">
                            <h3 id="pendingApps">0</h3>
                            <p>Pending</p>
                        </div>
                        <div class="stat-icon">‚è±</div>
                    </div>
                </div>

                <h2 style="color: white; margin-bottom: 20px; font-size: 24px;">Apply for Documents</h2>
                <div class="apply-grid">
                    <div class="apply-card" onclick="openApplicationForm('Barangay Clearance')">
                        <div class="apply-card-icon blue">üìã</div>
                        <h3>Barangay Clearance</h3>
                        <p>Required for employment, business permits, and other legal purposes. Processing fee: ‚Ç±100.00</p>
                    </div>

                    <div class="apply-card" onclick="openApplicationForm('Barangay ID')">
                        <div class="apply-card-icon green">ü™™</div>
                        <h3>Barangay ID</h3>
                        <p>Official identification card for barangay residents with QR code verification. Processing fee: ‚Ç±100.00</p>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Recent Applications</h2>
                    <div id="recentApplications">
                        <p style="text-align: center; color: #666;">No applications yet</p>
                    </div>
                </div>
            </div>

            <!-- Applications Section -->
            <div id="applicationsSection" class="section-content hidden">
                <div class="content-section">
                    <h2>All My Applications</h2>
                    <div id="allApplications">
                        <p style="text-align: center; color: #666;">No applications yet</p>
                    </div>
                </div>
            </div>

            <!-- Appointments Section -->
<div id="appointmentsSection" class="section-content hidden">
    <div class="content-section">
        <h2>My Appointments</h2>
        <button class="submit-btn" onclick="openAppointmentModal()" style="max-width: 300px; margin-bottom: 20px;">Schedule New Appointment</button>
        <div id="appointmentsList">
            <p style="text-align: center; color: #666;">No appointments scheduled</p>
        </div>
    </div>
</div>

            <!-- Complaints Section -->
<div id="complaintsSection" class="section-content hidden">
    <div class="content-section">
        <h2>My Complaints</h2>
        <button class="submit-btn" onclick="openComplaintModal()" style="max-width: 300px; margin-bottom: 20px;">Submit New Complaint</button>
        <div id="complaintsList">
            <p style="text-align: center; color: #666;">No complaints submitted</p>
        </div>
    </div>
</div>

<!-- Profile Section -->
<div id="profileSection" class="section-content hidden">
    <div class="content-section">
        <h2>My Profile</h2>
        
        <div style="max-width: 800px; margin: 0 auto;">
            <!-- Profile Header -->
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 30px; border-radius: 15px; text-align: center; color: white; margin-bottom: 30px;">
                <div style="width: 100px; height: 100px; border-radius: 50%; background: white; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                    üë§
                </div>
                <h3 id="profileName" style="font-size: 24px; margin-bottom: 5px;">Loading...</h3>
                <p id="profileEmail" style="opacity: 0.9;">Loading...</p>
            </div>

            <!-- Profile Information -->
            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #333; margin-bottom: 20px; font-size: 20px;">Account Information</h3>
                
                <div style="display: grid; gap: 20px;">
                    <div class="form-group">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">Full Name</label>
                        <input type="text" id="profileFullName" placeholder="Enter your full name" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>

                    <div class="form-group">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">Email Address</label>
                        <input type="email" id="profileEmailInput" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f0f0f0;">
                    </div>

                    <div class="form-group">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">Contact Number</label>
                        <input type="tel" id="profileContact" placeholder="09XX-XXX-XXXX" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>

                    <div class="form-group">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">Complete Address</label>
                        <textarea id="profileAddress" rows="3" placeholder="House No., Street, Barangay, City" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">Date of Birth</label>
                        <input type="date" id="profileDOB" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>

                <button onclick="updateProfile()" class="submit-btn" style="margin-top: 25px;">üíæ Save Profile Changes</button>
            </div>

            <!-- Account Statistics -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 30px;">
                <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 32px; color: #667eea; font-weight: 700;" id="profileTotalApps">0</div>
                    <div style="color: #666; font-size: 14px; margin-top: 5px;">Total Applications</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 32px; color: #10b981; font-weight: 700;" id="profileApproved">0</div>
                    <div style="color: #666; font-size: 14px; margin-top: 5px;">Approved</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 32px; color: #f59e0b; font-weight: 700;" id="profilePending">0</div>
                    <div style="color: #666; font-size: 14px; margin-top: 5px;">Pending</div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Application Form Modal -->
    <div id="applicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Apply for Document</h2>
                <button class="close-btn" onclick="closeModal('application')">√ó</button>
            </div>

            <form id="applicationForm" onsubmit="submitApplication(event)">
    <input type="hidden" id="documentType" name="type">

    <div class="form-group">
        <label>First Name *</label>
        <input type="text" name="firstName" id="firstName" required>
    </div>

    <div class="form-group">
        <label>Middle Name</label>
        <input type="text" name="middleName" id="middleName">
    </div>

    <div class="form-group">
        <label>Last Name *</label>
        <input type="text" name="lastName" id="lastName" required>
    </div>

    <div class="form-group">
        <label>Date of Birth *</label>
        <input type="date" name="dateOfBirth" id="dateOfBirth" required>
    </div>

    <div class="form-group">
        <label>Contact Number *</label>
        <input type="tel" name="contact" id="contact" required>
    </div>

    <div class="form-group">
        <label>Email Address *</label>
        <input type="email" name="email" id="email" required readonly style="background: #f0f0f0;">
    </div>

    <div class="form-group">
        <label>Complete Address *</label>
        <textarea name="address" id="address" rows="3" required></textarea>
    </div>

    <div class="form-group" id="purposeGroup" style="display: none;">
        <label>Purpose of Clearance *</label>
        <select name="purpose" id="purpose">
            <option value="">Select Purpose</option>
            <option value="employment">Employment</option>
            <option value="business">Business Permit</option>
            <option value="loan">Loan Application</option>
            <option value="scholarship">Scholarship</option>
            <option value="others">Others</option>
        </select>
    </div>

    <div class="form-group">
        <label>Delivery Method *</label>
        <select name="deliveryMethod" id="deliveryMethod" required>
            <option value="pickup">Pickup at Barangay Hall</option>
            <option value="deliver">Home Delivery</option>
        </select>
    </div>

   <div class="form-group" id="validIdGroup">
    <label id="validIdLabel">Upload Valid ID *</label>
    <div class="upload-area" id="validIdArea" onclick="document.getElementById('validId').click()">
        <p id="validIdText">üìé Click to upload</p>
        <p style="font-size: 12px; color: #666;" id="validIdHint">Maximum file size: 5MB</p>
    </div>
    <input type="file" name="validId" id="validId" style="display: none;" accept="image/*" required>
</div>

    <div class="form-group">
        <label>Upload Proof of Address *</label>
        <div class="upload-area" id="proofAddressArea" onclick="document.getElementById('proofAddress').click()">
            <p>üìé Click to upload</p>
            <p style="font-size: 12px; color: #666;">Maximum file size: 5MB</p>
        </div>
        <input type="file" name="proofOfAddress" id="proofAddress" style="display: none;" accept="image/*" required>
    </div>

    <!-- GCash Payment Section -->
    <div class="payment-section" style="background: #f8f9ff; border: 2px solid #667eea; border-radius: 12px; padding: 25px; margin: 25px 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="background: #007dff; color: white; padding: 8px 20px; border-radius: 8px; font-weight: bold; font-size: 18px;">GCash</div>
            <div style="font-size: 28px; font-weight: bold; color: #667eea;">‚Ç±100.00</div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; color: #333;">Payment Instructions:</h3>
            <ol style="margin-left: 20px; color: #555;">
                <li style="margin-bottom: 10px;">Open your GCash app</li>
                <li style="margin-bottom: 10px;">Select "Send Money" or scan the QR code below</li>
                <li style="margin-bottom: 10px;">Send ‚Ç±100.00 to the account below</li>
                <li style="margin-bottom: 10px;">Take a screenshot of the payment confirmation</li>
                <li style="margin-bottom: 10px;">Enter the GCash reference number below</li>
            </ol>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <div style="background: white; padding: 20px; border-radius: 12px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                <p style="margin-bottom: 10px; font-weight: bold; color: #333;">Scan to Pay via GCash</p>
                <img src="./images/instapay-qr.png"
     alt="GCash QR Code" 
     style="width: 200px; height: 200px; border: 2px solid #007dff; border-radius: 8px; object-fit: contain;">
                <p style="font-size: 12px; color: #666; margin-top: 10px;">GCash: 0993-715-2234</p>
            </div>
        </div>

        <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="margin: 8px 0; color: #555;"><strong>GCash Account Name:</strong> Barangay Pembo</p>
            <p style="margin: 8px 0; color: #555;"><strong>Mobile Number:</strong> 0993-715-2234</p>
            <p style="margin: 8px 0; color: #555;"><strong>Amount:</strong> ‚Ç±100.00</p>
        </div>

        <div class="form-group">
            <label>GCash Reference Number *</label>
            <input type="text" name="gcashReference" id="gcashReference" placeholder="Enter 13-digit reference number" required pattern="[0-9]{13}" maxlength="13">
            <p style="font-size: 12px; color: #666; margin-top: 5px;">Example: 1234567890123</p>
        </div>
    </div>

    <button type="submit" class="submit-btn">Submit Application with Payment</button>
</form>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Schedule Appointment</h2>
                <button class="close-btn" onclick="closeModal('appointment')">√ó</button>
            </div>

            <form id="appointmentForm" onsubmit="submitAppointment(event)">
                <div class="form-group">
    <label>Purpose of Appointment *</label>
    <select id="appointmentPurpose" required onchange="toggleCertificateFields()">
        <option value="">Select Purpose</option>
        <option value="File Complaint / Mediation">File Complaint / Mediation</option>
        <option value="Incident / Blotter Report">Incident / Blotter Report</option>
        <option value="Document Inquiry">Document Inquiry</option>
        <option value="Claim Documents">Claim Documents</option>
        <option value="Facility Reservation">Facility Reservation</option>
        <option value="Consultation with Barangay Official">Consultation with Barangay Official</option>
        <option value="Request for Certificate">Request for Certificate</option>
        <option value="Others">Others</option>
    </select>
</div>

<!-- üÜï CERTIFICATE REQUEST FIELDS -->
<div id="certificateFields" style="display: none; background: #f8f9ff; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #667eea;">
    <h3 style="color: #667eea; margin-bottom: 15px;">üìã Certificate Request Details</h3>
    
    <div class="form-group">
        <label>Full Name *</label>
        <input type="text" id="certFullName" placeholder="First Name Middle Name Last Name">
    </div>
    
    <div class="form-group">
        <label>Date of Birth *</label>
        <input type="date" id="certDateOfBirth">
    </div>
    
    <div class="form-group">
        <label>Age *</label>
        <input type="number" id="certAge" placeholder="Age" min="1" max="120">
    </div>
    
    <div class="form-group">
        <label>Sex *</label>
        <select id="certSex">
            <option value="">Select Sex</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Complete Address *</label>
        <textarea id="certAddress" rows="2" placeholder="House No., Street, Barangay, City"></textarea>
    </div>
    
    <div class="form-group">
        <label>Years of Residency *</label>
        <input type="number" id="certResidency" placeholder="Number of years" min="0">
    </div>
    
    <div class="form-group">
        <label>Contact Number *</label>
        <input type="tel" id="certContact" placeholder="09XX-XXX-XXXX">
    </div>
    
    <div class="form-group">
        <label>Type of Certificate *</label>
        <select id="certType">
            <option value="">Select Certificate Type</option>
            <option value="Certificate of Residency">Certificate of Residency</option>
            <option value="Certificate of Indigency">Certificate of Indigency</option>
            <option value="Certificate of Good Moral Character">Certificate of Good Moral Character</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Purpose of Certificate *</label>
        <textarea id="certPurpose" rows="2" placeholder="E.g., Employment, School requirement, Government transaction"></textarea>
    </div>
</div>

                <div class="form-group">
    <label>Preferred Date *</label>
    <input type="date" id="appointmentDate" required>
</div>

                <div class="form-group">
                    <label>Preferred Time *</label>
                    <select id="appointmentTime" required>
                        <option value="">Select Time</option>
                        <option value="9:00 AM">9:00 AM</option>
                        <option value="10:00 AM">10:00 AM</option>
                        <option value="11:00 AM">11:00 AM</option>
                        <option value="1:00 PM">1:00 PM</option>
                        <option value="2:00 PM">2:00 PM</option>
                        <option value="3:00 PM">3:00 PM</option>
                        <option value="4:00 PM">4:00 PM</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Contact Number *</label>
                    <input type="tel" id="appointmentContact" placeholder="09XX-XXX-XXXX" required>
                </div>

                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea id="appointmentNotes" rows="3" placeholder="Any special requests or information"></textarea>
                </div>

                <button type="submit" class="submit-btn">Schedule Appointment</button>
            </form>
        </div>
    </div>

    <!-- Complaint Modal -->
    <div id="complaintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submit Complaint</h2>
                <button class="close-btn" onclick="closeModal('complaint')">√ó</button>
            </div>

            <form id="complaintForm" onsubmit="submitComplaint(event)">
                <div class="form-group">
                    <label>Complaint Category *</label>
                    <select id="complaintCategory" required>
                        <option value="">Select Category</option>
                        <option value="Noise Complaint">Noise Complaint</option>
                        <option value="Street Issues">Street/Road Issues</option>
                        <option value="Garbage/Waste">Garbage/Waste Management</option>
                        <option value="Street Lights">Street Lights</option>
                        <option value="Water/Drainage">Water/Drainage Issues</option>
                        <option value="Safety Concerns">Safety Concerns</option>
                        <option value="Others">Others</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Subject *</label>
                    <input type="text" id="complaintSubject" placeholder="Brief subject of complaint" required>
                </div>

                <div class="form-group">
                    <label>Location/Address *</label>
                    <input type="text" id="complaintLocation" placeholder="Where is the issue located?" required>
                </div>

                <div class="form-group">
                    <label>Detailed Description *</label>
                    <textarea id="complaintDescription" rows="5" placeholder="Please provide detailed information about your complaint" required></textarea>
                </div>

                <div class="form-group">
                    <label>Contact Number *</label>
                    <input type="tel" id="complaintContact" placeholder="09XX-XXX-XXXX" required>
                </div>

                <div class="form-group">
                    <label>Upload Evidence (Optional)</label>
                    <div class="upload-area" onclick="document.getElementById('complaintEvidence').click()">
                        <p>üìé Click to upload photo/document</p>
                        <p style="font-size: 12px; color: #666;">Maximum file size: 5MB</p>
                    </div>
                    <input type="file" id="complaintEvidence" style="display: none;" accept="image/*,.pdf">
                </div>

                <button type="submit" class="submit-btn">Submit Complaint</button>
            </form>
        </div>
    </div>

    <script>
        const apiUrl = window.location.hostname === 'localhost' 
  ? 'http://localhost:3000' 
  : 'https://barangay-pembo-system.onrender.com';

console.log('üåê API URL:', apiUrl);

// ‚úÖ TEST CONNECTION
window.addEventListener('load', async function() {
    const messageElem = document.getElementById('message');
    
    try {
        console.log('üîç Testing server connection...');
        const response = await fetch(`${apiUrl}/health`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Server connected:', data);
            
            if (messageElem) {
                messageElem.textContent = '‚úÖ Server connected successfully';
                messageElem.classList.add('success');
                setTimeout(() => messageElem.textContent = '', 3000);
            }
        } else {
            throw new Error('Server returned: ' + response.status);
        }
    } catch (err) {
        console.error('‚ùå Connection failed:', err);
        
        if (messageElem) {
            messageElem.textContent = '‚ö†Ô∏è Cannot connect to server. Check console for details.';
            messageElem.classList.add('error');
        }
    }
});
        let myApplications = [];
        let myAppointments = [];
        let myComplaints = [];

        document.addEventListener('DOMContentLoaded', function() {
    loadUserData();
    updateDate();
    loadApplicationsFromDatabase();
    loadAppointmentsFromDatabase();
    loadComplaintsFromDatabase();
    loadProfileData();  // üÜï DAGDAG ITO
});

        function loadUserData() {
            const email = localStorage.getItem('email') || 'Resident';
            const category = localStorage.getItem('category') || 'Resident';
            document.getElementById('userName').textContent = `Welcome, ${email.split('@')[0]}`;
        }

        function updateDate() {
            const date = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('currentDate').textContent = date;
        }

        // üÜï LOAD APPLICATIONS FROM DATABASE
async function loadApplicationsFromDatabase() {
    const token = localStorage.getItem('token');
    const email = localStorage.getItem('email');
    
    if (!token || !email) {
        console.log('No token or email found');
        return;
    }
    
    try {
        const res = await fetch(`${apiUrl}/applications/my`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (res.ok) {
            const data = await res.json();
            myApplications = data.applications || [];
            displayApplications();
            updateStats();
        } else {
            console.error('Failed to load applications');
            myApplications = [];
        }
    } catch (err) {
        console.error('Error loading applications:', err);
        myApplications = [];
    }
}

        function displayApplications() {
    const recentDiv = document.getElementById('recentApplications');
    const allDiv = document.getElementById('allApplications');
    
    if (myApplications.length === 0) {
        recentDiv.innerHTML = '<p style="text-align: center; color: #666;">No applications yet</p>';
        allDiv.innerHTML = '<p style="text-align: center; color: #666;">No applications yet</p>';
        return;
    }

   const appHTML = myApplications.map(app => `
    <div class="application-item">
        <div class="app-info">
            <h4>${app.type}</h4>
            <p><strong>Name:</strong> ${app.firstName} ${app.lastName}</p>
            <p><strong>Date Applied:</strong> ${new Date(app.createdAt).toLocaleDateString()}</p>
            ${app.gcashReference ? `
                <p style="color: #10b981; font-weight: 600;">
                    üí∞ Paid via GCash: ${app.gcashReference}
                </p>
                <p style="color: #666; font-size: 12px;">
                    Payment Status: <span class="status-badge ${app.paymentStatus?.toLowerCase() || 'pending'}">${app.paymentStatus || 'Pending Verification'}</span>
                </p>
            ` : ''}
            
            <!-- üÜï DELIVERY STATUS -->
            ${app.deliveryStatus ? `
                <div style="margin-top: 15px; padding: 12px; background: ${app.deliveryStatus === 'Received' ? '#d1fae5' : '#fee2e2'}; border-radius: 8px;">
                    <p style="color: ${app.deliveryStatus === 'Received' ? '#065f46' : '#991b1b'}; font-weight: 600; margin: 0;">
                        ${app.deliveryStatus === 'Received' ? '‚úÖ Document Received' : '‚ùå Document Not Received'}
                    </p>
                    <p style="color: #666; font-size: 12px; margin-top: 5px;">
                        Updated: ${new Date(app.deliveryStatusDate).toLocaleDateString()}
                    </p>
                </div>
            ` : app.status === 'Approved' ? `
                <div style="margin-top: 15px; padding: 15px; background: #fffbeb; border-radius: 8px; border: 2px dashed #f59e0b;">
                    <p style="color: #92400e; font-weight: 600; margin-bottom: 10px;">üì¨ Document Status</p>
                    <p style="color: #78350f; font-size: 13px; margin-bottom: 12px;">
                        Have you received your ${app.type}?
                    </p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="updateDeliveryStatus('${app._id}', 'Received')" 
                            style="flex: 1; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            ‚úÖ Received
                        </button>
                        <button onclick="updateDeliveryStatus('${app._id}', 'Not Received')" 
                            style="flex: 1; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            ‚ùå Did Not Receive
                        </button>
                    </div>
                    <p style="color: #9ca3af; font-size: 11px; margin-top: 8px; text-align: center;">
                        Click after 24 hours if not received
                    </p>
                </div>
            ` : ''}
        </div>
        <span class="status-badge ${app.status.toLowerCase()}">${app.status}</span>
    </div>
`).join('');

    recentDiv.innerHTML = appHTML;
    allDiv.innerHTML = appHTML;
}

        function updateStats() {
            document.getElementById('totalApps').textContent = myApplications.length;
            document.getElementById('approvedApps').textContent = myApplications.filter(a => a.status === 'Approved').length;
            document.getElementById('pendingApps').textContent = myApplications.filter(a => a.status === 'Pending').length;
        }

        function showSection(section) {
    document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    document.getElementById(section + 'Section').classList.remove('hidden');
    event.target.closest('.menu-item').classList.add('active');
    
    // Load data when section is shown
    if (section === 'appointments') {
        loadAppointmentsFromDatabase();
    }
    if (section === 'complaints') {
        loadComplaintsFromDatabase();
    }
    if (section === 'profile') {  // üÜï DAGDAG ITO
        loadProfileData();
    }
}

    function openApplicationForm(type) {
    document.getElementById('modalTitle').textContent = `Apply for ${type}`;
    document.getElementById('documentType').value = type;
    
    // Auto-populate email
    const email = localStorage.getItem('email');
    if (email) {
        document.getElementById('email').value = email;
    }
    
    document.getElementById('applicationModal').classList.add('active');
    
    // Show/hide purpose field for clearance
    if (type === 'Barangay Clearance') {
        document.getElementById('purposeGroup').style.display = 'block';
    } else {
        document.getElementById('purposeGroup').style.display = 'none';
    }
    
    // üÜï CHANGE LABEL FOR BARANGAY ID
    if (type === 'Barangay ID') {
        document.getElementById('validIdLabel').textContent = 'Upload 1x1 Photo *';
        document.getElementById('validIdText').textContent = 'üì∑ Click to upload your 1x1 photo';
        document.getElementById('validIdHint').textContent = 'White background, passport size (Maximum 5MB)';
    } else {
        document.getElementById('validIdLabel').textContent = 'Upload Valid ID *';
        document.getElementById('validIdText').textContent = 'üìé Click to upload';
        document.getElementById('validIdHint').textContent = 'Maximum file size: 5MB';
    }
}
        function closeModal(type) {
    if (type === 'application') {
        document.getElementById('applicationModal').classList.remove('active');
        document.getElementById('applicationForm').reset();
        selectedValidId = null;
        selectedProofOfAddress = null;
        // Reset upload areas
        document.getElementById('validIdArea').innerHTML = '<p>üìé Click to upload</p><p style="font-size: 12px; color: #666;">Maximum file size: 5MB</p>';
        document.getElementById('proofAddressArea').innerHTML = '<p>üìé Click to upload</p><p style="font-size: 12px; color: #666;">Maximum file size: 5MB</p>';
    } else if (type === 'appointment') {
        document.getElementById('appointmentModal').classList.remove('active');
        document.getElementById('appointmentForm').reset();
    } else if (type === 'complaint') {
        document.getElementById('complaintModal').classList.remove('active');
        document.getElementById('complaintForm').reset();
        selectedComplaintEvidence = null;
    }
}
        // ==================== FILE UPLOAD HANDLERS ====================
let selectedValidId = null;
let selectedProofOfAddress = null;
let selectedComplaintEvidence = null;

document.getElementById('validId').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            e.target.value = '';
            return;
        }
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Only image files are allowed');
            e.target.value = '';
            return;
        }
        selectedValidId = file;
        // Update UI to show file is selected
        const uploadArea = e.target.previousElementSibling;
        uploadArea.innerHTML = `
            <p style="color: #10b981;">‚úì ${file.name}</p>
            <p style="font-size: 12px; color: #666;">${(file.size / 1024).toFixed(2)} KB</p>
        `;
    }
});

document.getElementById('proofAddress').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            e.target.value = '';
            return;
        }
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Only image files are allowed');
            e.target.value = '';
            return;
        }
        selectedProofOfAddress = file;
        // Update UI to show file is selected
        const uploadArea = e.target.previousElementSibling;
        uploadArea.innerHTML = `
            <p style="color: #10b981;">‚úì ${file.name}</p>
            <p style="font-size: 12px; color: #666;">${(file.size / 1024).toFixed(2)} KB</p>
        `;
    }
});

document.getElementById('complaintEvidence').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            e.target.value = '';
            return;
        }
        selectedComplaintEvidence = file;
        const uploadArea = e.target.previousElementSibling;
        uploadArea.innerHTML = `
            <p style="color: #10b981;">‚úì ${file.name}</p>
            <p style="font-size: 12px; color: #666;">${(file.size / 1024).toFixed(2)} KB</p>
        `;
    }
});

// ==================== SUBMIT APPLICATION WITH GCASH ====================
async function submitApplication(event) {
    event.preventDefault();
    
    console.log('üîµ Submit clicked!');
    
    const form = document.getElementById('applicationForm');
    const type = document.getElementById('documentType').value;
    const firstName = document.getElementById('firstName').value;
    const middleName = document.getElementById('middleName').value;
    const lastName = document.getElementById('lastName').value;
    const dob = document.getElementById('dateOfBirth').value;
    const contact = document.getElementById('contact').value;
    const email = document.getElementById('email').value;
    const address = document.getElementById('address').value;
    const purpose = document.getElementById('purposeGroup').style.display !== 'none' 
        ? document.getElementById('purpose').value 
        : '';
    const gcashReference = document.getElementById('gcashReference').value;
    const deliveryMethod = document.getElementById('deliveryMethod').value;
    
    console.log('üìù Form data:', {
        type, firstName, lastName, email, gcashReference
    });
    
    // ‚úÖ VALIDATE FILES
    if (!selectedValidId) {
        alert('Please upload your Valid ID');
        return;
    }
    
    if (!selectedProofOfAddress) {
        alert('Please upload your Proof of Address');
        return;
    }
    
    console.log('‚úÖ Files validated:', {
        validId: selectedValidId.name,
        proofOfAddress: selectedProofOfAddress.name
    });

    // ‚úÖ VALIDATE GCASH REFERENCE
    if (!gcashReference || gcashReference.length !== 13) {
        alert('Please enter a valid 13-digit GCash reference number');
        return;
    }
    
    console.log('‚úÖ GCash reference validated');
    
    // ‚úÖ CREATE FORMDATA
    const formData = new FormData();
    formData.append('email', email);
    formData.append('type', type);
    formData.append('firstName', firstName);
    formData.append('middleName', middleName);
    formData.append('lastName', lastName);
    formData.append('dateOfBirth', dob);
    formData.append('contact', contact);
    formData.append('address', address);
    formData.append('purpose', purpose);
    formData.append('validId', selectedValidId);
    formData.append('proofOfAddress', selectedProofOfAddress);
    formData.append('gcashReference', gcashReference);
    formData.append('paymentAmount', 100);
    formData.append('deliveryMethod', deliveryMethod);
    
    console.log('üì¶ FormData created');
    
    const token = localStorage.getItem('token');
    
    if (!token) {
        alert('Session expired. Please login again.');
        window.location.href = 'index.html';
        return;
    }
    
    console.log('üîë Token found, sending request...');
    
    try {
        const res = await fetch(`${apiUrl}/apply`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        console.log('üì° Response status:', res.status);
        
        const data = await res.json();
        console.log('üì• Response data:', data);
        
        if (res.ok) {
            alert(`‚úÖ Application submitted successfully!

üìã Document Type: ${type}
üë§ Name: ${firstName} ${lastName}
üí∞ Payment: ‚Ç±100.00
üî¢ GCash Reference: ${gcashReference}

‚è≥ Your application and payment are being verified by admin.
üìß You will receive an email notification once approved.`);
            
            closeModal('application');
            selectedValidId = null;
            selectedProofOfAddress = null;
            
            await loadApplicationsFromDatabase();
            
        } else {
            console.error('‚ùå Server error:', data);
            alert('‚ùå Failed to submit application\n\n' + (data.message || 'Please try again.'));
        }
        
    } catch (err) {
        console.error('üí• Network error:', err);
        alert('‚ùå Network error\n\n' + err.message + '\n\nPlease check your connection and try again.');
    }
}

        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Session timeout (15 minutes)
        setTimeout(() => {
            if (localStorage.getItem('token')) {
                logout();
                alert('Session expired. Please log in again.');
            }
        }, 15 * 60 * 1000);

    // üÜï LOAD APPOINTMENTS FROM DATABASE
async function loadAppointmentsFromDatabase() {
    const token = localStorage.getItem('token');
    const email = localStorage.getItem('email');
    
    if (!token || !email) return;
    
    try {
        const res = await fetch(`${apiUrl}/appointments/my?email=${email}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (res.ok) {
            const data = await res.json();
            myAppointments = data.appointments || [];
            displayAppointments();
        }
    } catch (err) {
        console.error('Error loading appointments:', err);
    }
}

// üÜï DISPLAY APPOINTMENTS
function displayAppointments() {
    const listDiv = document.getElementById('appointmentsList');
    
    if (myAppointments.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #666;">No appointments scheduled</p>';
        return;
    }

    const appointHTML = myAppointments.map(apt => `
        <div class="application-item">
            <div class="app-info">
                <h4>${apt.purpose}</h4>
                <p><strong>Date:</strong> ${new Date(apt.date).toLocaleDateString()} at ${apt.time}</p>
                <p><strong>Contact:</strong> ${apt.contact}</p>
                ${apt.notes ? `<p><strong>Notes:</strong> ${apt.notes}</p>` : ''}
                <p style="font-size: 12px; color: #666;">Scheduled on: ${new Date(apt.createdAt).toLocaleDateString()}</p>
            </div>
            <span class="status-badge ${apt.status.toLowerCase()}">${apt.status}</span>
        </div>
    `).join('');

    listDiv.innerHTML = appointHTML;
}

// üÜï OPEN APPOINTMENT MODAL
function openAppointmentModal() {
    document.getElementById('appointmentModal').classList.add('active');
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('appointmentDate').min = today;
}

// üÜï TOGGLE CERTIFICATE FIELDS
function toggleCertificateFields() {
    const purpose = document.getElementById('appointmentPurpose').value;
    const certFields = document.getElementById('certificateFields');
    
    if (purpose === 'Request for Certificate') {
        certFields.style.display = 'block';
        // Make certificate fields required
        document.getElementById('certFullName').required = true;
        document.getElementById('certDateOfBirth').required = true;
        document.getElementById('certAge').required = true;
        document.getElementById('certSex').required = true;
        document.getElementById('certAddress').required = true;
        document.getElementById('certResidency').required = true;
        document.getElementById('certContact').required = true;
        document.getElementById('certType').required = true;
        document.getElementById('certPurpose').required = true;
    } else {
        certFields.style.display = 'none';
        // Remove required from certificate fields
        document.getElementById('certFullName').required = false;
        document.getElementById('certDateOfBirth').required = false;
        document.getElementById('certAge').required = false;
        document.getElementById('certSex').required = false;
        document.getElementById('certAddress').required = false;
        document.getElementById('certResidency').required = false;
        document.getElementById('certContact').required = false;
        document.getElementById('certType').required = false;
        document.getElementById('certPurpose').required = false;
    }
}

// üÜï SUBMIT APPOINTMENT
async function submitAppointment(event) {
    event.preventDefault();
    
    const purpose = document.getElementById('appointmentPurpose').value;
    const date = document.getElementById('appointmentDate').value;
    const time = document.getElementById('appointmentTime').value;
    const contact = document.getElementById('appointmentContact').value;
    const notes = document.getElementById('appointmentNotes').value;
    const email = localStorage.getItem('email');
    const token = localStorage.getItem('token');
    
    // üÜï COLLECT CERTIFICATE DATA IF APPLICABLE
    let certificateData = null;
    if (purpose === 'Request for Certificate') {
        certificateData = {
            fullName: document.getElementById('certFullName').value,
            dateOfBirth: document.getElementById('certDateOfBirth').value,
            age: document.getElementById('certAge').value,
            sex: document.getElementById('certSex').value,
            address: document.getElementById('certAddress').value,
            residency: document.getElementById('certResidency').value,
            contact: document.getElementById('certContact').value,
            certificateType: document.getElementById('certType').value,
            certificatePurpose: document.getElementById('certPurpose').value
        };
    }
    
    try {
        const res = await fetch(`${apiUrl}/appointment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                email,
                purpose,
                date,
                time,
                contact,
                notes,
                certificateData
            })
        });
        
        if (res.ok) {
            const data = await res.json();
            
            let successMessage = `‚úÖ Appointment scheduled successfully!

üìÖ Date: ${new Date(date).toLocaleDateString()}
‚è∞ Time: ${time}
üìã Purpose: ${purpose}`;

            if (certificateData) {
                successMessage += `

üìú Certificate Details:
üë§ Name: ${certificateData.fullName}
üìÑ Type: ${certificateData.certificateType}`;
            }

            successMessage += `

‚è≥ Waiting for admin confirmation.
üìß You will receive an email notification.`;
            
            alert(successMessage);
            
            closeModal('appointment');
            await loadAppointmentsFromDatabase();
        } else {
            const error = await res.json();
            alert('Error: ' + error.message);
        }
    } catch (err) {
        console.error('Appointment error:', err);
        alert('Failed to schedule appointment. Please try again.');
    }
}

// üÜï LOAD COMPLAINTS FROM DATABASE
async function loadComplaintsFromDatabase() {
    const token = localStorage.getItem('token');
    const email = localStorage.getItem('email');
    
    if (!token || !email) return;
    
    try {
        const res = await fetch(`${apiUrl}/complaints/my?email=${email}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (res.ok) {
            const data = await res.json();
            myComplaints = data.complaints || [];
            displayComplaints();
        }
    } catch (err) {
        console.error('Error loading complaints:', err);
    }
}

// üÜï DISPLAY COMPLAINTS
function displayComplaints() {
    const listDiv = document.getElementById('complaintsList');
    
    if (myComplaints.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #666;">No complaints submitted</p>';
        return;
    }

    const complaintHTML = myComplaints.map(comp => `
        <div class="application-item" style="flex-direction: column; align-items: flex-start;">
            <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px;">
                <h4 style="color: #333;">${comp.subject}</h4>
                <span class="status-badge ${comp.status.toLowerCase().replace(' ', '-')}">${comp.status}</span>
            </div>
            <div class="app-info" style="width: 100%;">
                <p><strong>Category:</strong> ${comp.category}</p>
                <p><strong>Location:</strong> ${comp.location}</p>
                <p><strong>Description:</strong> ${comp.description}</p>
                <p><strong>Contact:</strong> ${comp.contact}</p>
                <p style="font-size: 12px; color: #666;">Submitted on: ${new Date(comp.createdAt).toLocaleDateString()}</p>
                ${comp.response ? `
                    <div style="margin-top: 10px; padding: 10px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 4px;">
                        <p style="font-weight: 600; color: #065f46; margin-bottom: 5px;">üìù Admin Response:</p>
                        <p style="color: #047857;">${comp.response}</p>
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');

    listDiv.innerHTML = complaintHTML;
}

// üÜï OPEN COMPLAINT MODAL
function openComplaintModal() {
    document.getElementById('complaintModal').classList.add('active');
}

// üÜï SUBMIT COMPLAINT
async function submitComplaint(event) {
    event.preventDefault();
    
    const category = document.getElementById('complaintCategory').value;
    const subject = document.getElementById('complaintSubject').value;
    const location = document.getElementById('complaintLocation').value;
    const description = document.getElementById('complaintDescription').value;
    const contact = document.getElementById('complaintContact').value;
    const email = localStorage.getItem('email');
    const token = localStorage.getItem('token');
    
    // Handle evidence file if uploaded
    let evidence = null;
    const evidenceFile = document.getElementById('complaintEvidence').files[0];
    if (evidenceFile) {
        // For now, we'll just note that evidence was uploaded
        // In production, you'd upload this to server
        evidence = evidenceFile.name;
    }
    
    try {
        const res = await fetch(`${apiUrl}/complaint`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                email,
                category,
                subject,
                location,
                description,
                contact,
                evidence
            })
        });
        
        if (res.ok) {
            const data = await res.json();
            
            alert(`‚úÖ Complaint submitted successfully!

üìÇ Category: ${category}
üìç Location: ${location}

‚è≥ Your complaint is under review.
üìß You will be notified when admin responds.`);
            
            closeModal('complaint');
            await loadComplaintsFromDatabase();
        } else {
            const error = await res.json();
            alert('Error: ' + error.message);
        }
    } catch (err) {
        console.error('Complaint error:', err);
        alert('Failed to submit complaint. Please try again.');
    }
}

// üÜï LOAD PROFILE DATA
function loadProfileData() {
    const email = localStorage.getItem('email');
    
    if (email) {
        document.getElementById('profileName').textContent = email.split('@')[0];
        document.getElementById('profileEmail').textContent = email;
        document.getElementById('profileEmailInput').value = email;
    }
    
    // Load stats
    document.getElementById('profileTotalApps').textContent = myApplications.length;
    document.getElementById('profileApproved').textContent = myApplications.filter(a => a.status === 'Approved').length;
    document.getElementById('profilePending').textContent = myApplications.filter(a => a.status === 'Pending').length;
}

// üÜï UPDATE PROFILE
async function updateProfile() {
    const fullName = document.getElementById('profileFullName').value;
    const contact = document.getElementById('profileContact').value;
    const address = document.getElementById('profileAddress').value;
    const dob = document.getElementById('profileDOB').value;
    
    if (!fullName || !contact || !address) {
        alert('‚ö†Ô∏è Please fill in all required fields');
        return;
    }
    
    alert('‚úÖ Profile updated successfully!\n\nYour information has been saved.');
    document.getElementById('profileName').textContent = fullName;
}

// üÜï UPDATE DELIVERY STATUS
async function updateDeliveryStatus(applicationId, status) {
    const confirmMsg = status === 'Received' 
        ? 'Confirm that you have received your document?' 
        : 'Confirm that you have NOT received your document after 24+ hours?';
    
    if (!confirm(confirmMsg)) return;
    
    const token = localStorage.getItem('token');
    
    try {
        const res = await fetch(`${apiUrl}/application/delivery-status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ 
                applicationId, 
                deliveryStatus: status 
            })
        });
        
        if (res.ok) {
            alert(status === 'Received' 
                ? '‚úÖ Thank you for confirming! Your feedback has been recorded.' 
                : '‚ö†Ô∏è We apologize for the inconvenience. The barangay office has been notified.');
            
            await loadApplicationsFromDatabase();
        } else {
            alert('Failed to update delivery status');
        }
    } catch (err) {
        console.error('Error:', err);
        alert('Error updating status');
    }
}

    </script>
</body>
</html>